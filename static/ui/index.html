<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunny Â· Intelligent Risk Studio</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-deep: #020617;
            --bg-surface: rgba(15, 23, 42, 0.6);
            --bg-card: rgba(30, 41, 59, 0.4);
            --border-soft: rgba(148, 163, 184, 0.1);
            --border-highlight: rgba(56, 189, 248, 0.3);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-cyan: #38bdf8;
            --accent-purple: #c084fc;
            --accent-emerald: #34d399;
            --accent-rose: #fb7185;
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Animated Background */
        .bg-gradient-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: 
                radial-gradient(circle at 15% 50%, rgba(56, 189, 248, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(192, 132, 252, 0.08), transparent 25%);
            pointer-events: none;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--bg-surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-soft);
            box-shadow: var(--glass-shadow);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            border-color: rgba(148, 163, 184, 0.2);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
        }

        .glass-card {
            background: var(--bg-card);
            border: 1px solid var(--border-soft);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.5);
        }

        /* Form Elements */
        .input-field {
            background: rgba(2, 6, 23, 0.5);
            border: 1px solid var(--border-soft);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
            outline: none;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), #0ea5e9);
            color: #0f172a;
            font-weight: 600;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        /* Map Container */
        #map-container {
            height: 400px;
            width: 100%;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--border-soft);
            position: relative;
            z-index: 0;
        }
        
        /* Leaflet Customization */
        .leaflet-container {
            background: #0f172a;
            font-family: 'Inter', sans-serif;
        }
        .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            color: var(--text-primary);
            border: 1px solid var(--border-soft);
            border-radius: 0.5rem;
        }
        .leaflet-popup-tip {
            background: rgba(15, 23, 42, 0.9);
        }

        /* Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .animate-pulse-ring::before {
            content: '';
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            border-radius: 50%;
            border: 2px solid var(--accent-rose);
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-live { background-color: var(--accent-emerald); box-shadow: 0 0 8px var(--accent-emerald); }
        .status-idle { background-color: var(--text-secondary); }

    </style>
</head>
<body>
    <div class="bg-gradient-mesh"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Components ---

        const MapComponent = ({ lat, lon, address, riskScore }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);

            useEffect(() => {
                if (!mapInstanceRef.current) {
                    // Initialize map
                    mapInstanceRef.current = L.map(mapRef.current).setView([lat || 39.8283, lon || -98.5795], 4);
                    
                    // Dark mode tiles
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(mapInstanceRef.current);
                }

                const map = mapInstanceRef.current;

                if (lat && lon) {
                    map.setView([lat, lon], 16, { animate: true, duration: 1.5 });
                    
                    if (markerRef.current) {
                        markerRef.current.setLatLng([lat, lon]);
                    } else {
                        // Custom marker icon could go here
                        markerRef.current = L.marker([lat, lon]).addTo(map);
                    }

                    const popupContent = `
                        <div class="text-sm font-medium">
                            <div class="text-cyan-400 mb-1">Target Property</div>
                            <div>${address}</div>
                            ${riskScore ? `<div class="mt-2 pt-2 border-t border-gray-700">Risk Score: <span class="${riskScore > 7 ? 'text-red-400' : riskScore > 4 ? 'text-yellow-400' : 'text-green-400'} font-bold">${riskScore}/10</span></div>` : ''}
                        </div>
                    `;
                    markerRef.current.bindPopup(popupContent).openPopup();
                }

            }, [lat, lon, address, riskScore]);

            return <div id="map-container" ref={mapRef}></div>;
        };

        const StatCard = ({ label, value, icon, trend, color = "text-cyan-400" }) => (
            <div className="glass-card flex items-center justify-between group hover:bg-white/5 transition-colors">
                <div>
                    <div className="text-xs text-gray-400 uppercase tracking-wider mb-1">{label}</div>
                    <div className="text-2xl font-bold font-space text-white">{value}</div>
                    {trend && <div className="text-xs text-gray-500 mt-1">{trend}</div>}
                </div>
                <div className={`p-3 rounded-lg bg-white/5 ${color} group-hover:scale-110 transition-transform`}>
                    <i className={icon + " text-xl"}></i>
                </div>
            </div>
        );

        const RiskGauge = ({ score }) => {
            const radius = 36;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - ((score || 0) / 10) * circumference;
            
            let color = "text-green-400";
            if (score > 4) color = "text-yellow-400";
            if (score > 7) color = "text-red-500";

            return (
                <div className="relative flex items-center justify-center w-32 h-32 mx-auto">
                    <svg className="transform -rotate-90 w-full h-full">
                        <circle cx="64" cy="64" r={radius} stroke="currentColor" strokeWidth="8" fill="transparent" className="text-gray-800" />
                        <circle cx="64" cy="64" r={radius} stroke="currentColor" strokeWidth="8" fill="transparent" 
                                strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round"
                                className={`${color} transition-all duration-1000 ease-out`} />
                    </svg>
                    <div className="absolute text-center">
                        <div className={`text-3xl font-bold ${color}`}>{score || "-"}</div>
                        <div className="text-xs text-gray-500">RISK SCORE</div>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        function App() {
            // State
            const [address, setAddress] = useState('1600 Pennsylvania Avenue NW, Washington, DC');
            const [query, setQuery] = useState('Assess comprehensive risk factors including seismic and civil unrest.');
            const [assessment, setAssessment] = useState(null);
            const [loading, setLoading] = useState(false);
            const [systemStats, setSystemStats] = useState(null);
            const [activeAlerts, setActiveAlerts] = useState([]);
            const [notification, setNotification] = useState(null);
            const [autoRefresh, setAutoRefresh] = useState(false);

            // Derived State for Map
            const mapLat = assessment?.location_factors?.latitude || (assessment?.data?.location_factors?.latitude);
            const mapLon = assessment?.location_factors?.longitude || (assessment?.data?.location_factors?.longitude);

            // Effects
            useEffect(() => {
                fetchSystemStats();
                const interval = setInterval(fetchSystemStats, 30000);
                return () => clearInterval(interval);
            }, []);

            // Actions
            const fetchSystemStats = async () => {
                try {
                    const res = await fetch('/stats');
                    if (res.ok) setSystemStats(await res.json());
                } catch (e) { console.error(e); }
            };

            const fetchAssessment = async () => {
                if (!address.trim()) return;
                setLoading(true);
                try {
                    const res = await fetch('/get_assessment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, query })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setAssessment(data.data);
                        setNotification({ type: 'success', message: 'Assessment updated successfully' });
                    } else {
                        throw new Error(data.detail || 'Assessment failed');
                    }
                } catch (e) {
                    setNotification({ type: 'error', message: e.message });
                } finally {
                    setLoading(false);
                }
            };

            const injectTestAlert = async (type) => {
                setNotification({ type: 'info', message: `Injecting ${type} alert...` });
                try {
                    const res = await fetch('/inject_test_alert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, alert_type: type, active_alerts: activeAlerts })
                    });
                    if (res.ok) {
                        setActiveAlerts(prev => [...prev, type]);
                        fetchAssessment(); // Refresh to see impact
                    }
                } catch (e) {
                    setNotification({ type: 'error', message: 'Failed to inject alert' });
                }
            };

            // Render Helpers
            const getRiskLevel = (score) => {
                if (!score) return 'Unknown';
                if (score <= 3) return 'Low Risk';
                if (score <= 6) return 'Moderate Risk';
                return 'High Risk';
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
                    
                    {/* Header */}
                    <header className="flex items-center justify-between mb-8 glass-panel p-4">
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-lg shadow-cyan-500/20">
                                <i className="fas fa-shield-alt text-white text-xl"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight">Sunny <span className="font-light text-gray-400">Risk Studio</span></h1>
                                <div className="flex items-center gap-2 text-xs text-gray-400">
                                    <span className={`status-dot ${systemStats ? 'status-live' : 'status-idle'}`}></span>
                                    {systemStats ? 'System Online' : 'Connecting...'}
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button className="glass-card px-4 py-2 text-sm hover:bg-white/5 transition-colors" onClick={() => setAutoRefresh(!autoRefresh)}>
                                <i className={`fas fa-sync-alt mr-2 ${autoRefresh ? 'animate-spin text-cyan-400' : ''}`}></i>
                                {autoRefresh ? 'Auto-Sync On' : 'Auto-Sync Off'}
                            </button>
                        </div>
                    </header>

                    {/* Notification Toast */}
                    {notification && (
                        <div className={`fixed top-4 right-4 p-4 rounded-lg shadow-2xl backdrop-blur-md border z-50 animate-fade-in-down ${
                            notification.type === 'error' ? 'bg-red-900/80 border-red-500/50 text-red-100' : 
                            notification.type === 'success' ? 'bg-green-900/80 border-green-500/50 text-green-100' : 
                            'bg-blue-900/80 border-blue-500/50 text-blue-100'
                        }`}>
                            <div className="flex items-center gap-3">
                                <i className={`fas ${notification.type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}`}></i>
                                {notification.message}
                                <button onClick={() => setNotification(null)} className="ml-4 opacity-50 hover:opacity-100"><i className="fas fa-times"></i></button>
                            </div>
                        </div>
                    )}

                    {/* Main Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* Left Column: Controls & Map (7 cols) */}
                        <div className="lg:col-span-7 space-y-6">
                            
                            {/* Map Section */}
                            <div className="glass-panel p-1">
                                <MapComponent 
                                    lat={mapLat} 
                                    lon={mapLon} 
                                    address={address}
                                    riskScore={assessment?.risk_score}
                                />
                            </div>

                            {/* Input Controls */}
                            <div className="glass-panel p-6">
                                <h3 className="text-lg font-medium mb-4 flex items-center gap-2">
                                    <i className="fas fa-search-location text-cyan-400"></i>
                                    Property Analysis
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs uppercase tracking-wider text-gray-500 mb-1">Property Address</label>
                                        <div className="relative">
                                            <input 
                                                type="text" 
                                                value={address}
                                                onChange={(e) => setAddress(e.target.value)}
                                                className="w-full input-field rounded-lg p-3 pl-10 font-mono text-sm"
                                                placeholder="Enter full address..."
                                            />
                                            <i className="fas fa-map-marker-alt absolute left-3 top-3.5 text-gray-500"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs uppercase tracking-wider text-gray-500 mb-1">Assessment Focus</label>
                                        <textarea 
                                            value={query}
                                            onChange={(e) => setQuery(e.target.value)}
                                            className="w-full input-field rounded-lg p-3 text-sm h-24 resize-none"
                                            placeholder="Specific risks to analyze..."
                                        ></textarea>
                                    </div>
                                    <button 
                                        onClick={fetchAssessment}
                                        disabled={loading}
                                        className="w-full btn-primary rounded-lg p-3 shadow-lg shadow-cyan-500/20 flex items-center justify-center gap-2"
                                    >
                                        {loading ? <i className="fas fa-circle-notch animate-spin"></i> : <i className="fas fa-bolt"></i>}
                                        {loading ? 'Analyzing Risk Profile...' : 'Generate Assessment'}
                                    </button>
                                </div>
                            </div>

                            {/* Simulation Controls */}
                            <div className="glass-panel p-6">
                                <h3 className="text-lg font-medium mb-4 flex items-center gap-2">
                                    <i className="fas fa-flask text-purple-400"></i>
                                    Scenario Injection
                                </h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {['fire', 'flood', 'crime', 'earthquake'].map(type => (
                                        <button 
                                            key={type}
                                            onClick={() => injectTestAlert(type)}
                                            className="glass-card p-3 text-center hover:bg-white/10 transition-colors flex flex-col items-center gap-2"
                                        >
                                            <i className={`fas fa-${type === 'crime' ? 'mask' : type === 'earthquake' ? 'house-crack' : type} text-xl ${
                                                type === 'fire' ? 'text-orange-500' : 
                                                type === 'flood' ? 'text-blue-500' : 
                                                type === 'crime' ? 'text-yellow-500' : 'text-purple-500'
                                            }`}></i>
                                            <span className="text-xs uppercase font-medium">{type}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Right Column: Analytics & Results (5 cols) */}
                        <div className="lg:col-span-5 space-y-6">
                            
                            {/* Key Metrics */}
                            <div className="grid grid-cols-2 gap-4">
                                <StatCard 
                                    label="Est. Premium" 
                                    value={assessment ? `$${Math.round(assessment.insurance_quote)}` : '---'} 
                                    icon="fas fa-file-invoice-dollar"
                                    trend={assessment ? "Monthly" : ""}
                                    color="text-emerald-400"
                                />
                                <StatCard 
                                    label="Data Points" 
                                    value={assessment ? assessment.relevant_documents : '0'} 
                                    icon="fas fa-database"
                                    color="text-blue-400"
                                />
                            </div>

                            {/* Risk Score Card */}
                            <div className="glass-panel p-6 text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
                                <h3 className="text-lg font-medium mb-6">Risk Analysis</h3>
                                <RiskGauge score={assessment?.risk_score} />
                                <div className="mt-4 text-lg font-medium tracking-wide">
                                    {getRiskLevel(assessment?.risk_score)}
                                </div>
                                {assessment?.timestamp && (
                                    <div className="text-xs text-gray-500 mt-2">
                                        Generated: {new Date(assessment.timestamp).toLocaleTimeString()}
                                    </div>
                                )}
                            </div>

                            {/* AI Analysis */}
                            <div className="glass-panel p-6 flex-grow min-h-[300px]">
                                <h3 className="text-lg font-medium mb-4 flex items-center gap-2">
                                    <i className="fas fa-brain text-pink-400"></i>
                                    Intelligence Brief
                                </h3>
                                <div className="prose prose-invert prose-sm max-w-none">
                                    {assessment ? (
                                        <div className="whitespace-pre-wrap text-gray-300 leading-relaxed">
                                            {assessment.risk_summary}
                                        </div>
                                    ) : (
                                        <div className="text-center text-gray-500 py-12">
                                            <i className="fas fa-search text-4xl mb-4 opacity-20"></i>
                                            <p>Enter a property address to generate a comprehensive risk assessment.</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* System Status */}
                            <div className="glass-panel p-4">
                                <div className="flex items-center justify-between text-xs text-gray-400">
                                    <span>Docs Indexed: {systemStats?.documents_indexed || '-'}</span>
                                    <span>Vector Store: {systemStats?.vector_store_size || '-'}</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
