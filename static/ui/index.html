<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunny · Intelligent Risk Studio</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-deep: #020617;
            --bg-surface: rgba(8, 12, 24, 0.8);
            --bg-soft: rgba(11, 17, 34, 0.7);
            --border-soft: rgba(255, 255, 255, 0.08);
            --border-strong: rgba(255, 255, 255, 0.15);
            --text-high: #f8fafc;
            --text-mid: #cbd5f5;
            --text-muted: #94a3b8;
            --accent-cyan: #22d3ee;
            --accent-purple: #c084fc;
            --accent-amber: #fbbf24;
            --accent-rose: #fb7185;
            --accent-green: #34d399;
            --glass-shadow: 0 35px 65px rgba(3, 7, 18, 0.55);
        }

        .app-body.theme-light {
            --bg-deep: #f4f6fb;
            --bg-surface: rgba(255, 255, 255, 0.92);
            --bg-soft: rgba(255, 255, 255, 0.88);
            --border-soft: rgba(15, 23, 42, 0.08);
            --border-strong: rgba(15, 23, 42, 0.2);
            --text-high: #0f172a;
            --text-mid: #1e293b;
            --text-muted: #475569;
            --accent-cyan: #0891b2;
            --accent-purple: #7c3aed;
            --accent-amber: #d97706;
            --accent-rose: #dc2626;
            --accent-green: #0f766e;
            --glass-shadow: 0 20px 45px rgba(15, 23, 42, 0.15);
        }

        .app-body.theme-light .glass-panel {
            background: var(--bg-surface);
            border-color: var(--border-soft);
        }

        .app-body.theme-light .chip,
        .app-body.theme-light .metric-pill,
        .app-body.theme-light .analysis-chip,
        .app-body.theme-light .timeline-list,
        .app-body.theme-light .data-feed,
        .app-body.theme-light .summary-card .body {
            background: rgba(15, 23, 42, 0.03);
            border-color: rgba(15, 23, 42, 0.08);
        }

        .app-body.theme-light .nav-links button {
            color: var(--text-muted);
        }

        .app-body.theme-light .nav-links button.active,
        .app-body.theme-light .nav-links button:hover {
            color: var(--text-high);
            border-color: rgba(15, 23, 42, 0.15);
            background: rgba(15, 23, 42, 0.05);
        }

        .app-body.theme-light .status-pill.status-live {
            color: #064e3b;
        }

        .app-body.theme-light .status-pill.status-idle {
            color: var(--text-mid);
            border-color: rgba(15, 23, 42, 0.25);
        }

        .app-body.theme-light .tone-low { color: #0f766e; }
        .app-body.theme-light .tone-medium { color: #b45309; }
        .app-body.theme-light .tone-high { color: #be123c; }
        .app-body.theme-light .tone-critical { color: #991b1b; }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Space Grotesk', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-high);
            min-height: 100vh;
        }

        .app-shell {
            position: relative;
            min-height: 100vh;
            padding: clamp(2rem, 4vw, 4rem) 0 4.5rem;
            overflow: hidden;
        }

        .app-shell::before,
        .app-shell::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.18), transparent 45%),
                        radial-gradient(circle at 80% 0%, rgba(192, 132, 252, 0.22), transparent 40%),
                        radial-gradient(circle at 50% 80%, rgba(251, 113, 133, 0.15), transparent 50%);
            z-index: 0;
            opacity: 0.8;
        }

        .app-shell::after {
            background-image: url("data:image/svg+xml,%3Csvg width='160' height='160' viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M80 0v160M0 80h160' stroke='rgba(148,163,184,0.07)' stroke-width='1'/%3E%3C/svg%3E");
            mix-blend-mode: soft-light;
            opacity: 0.4;
        }

        .content-wrap {
            position: relative;
            z-index: 1;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 clamp(1.25rem, 3vw, 2.5rem);
        }

        .glass-panel {
            background: var(--bg-soft);
            border: 1px solid var(--border-soft);
            border-radius: 28px;
            box-shadow: var(--glass-shadow);
            -webkit-backdrop-filter: blur(28px);
            backdrop-filter: blur(28px);
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .glass-panel::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            border: 1px solid rgba(255, 255, 255, 0.03);
            pointer-events: none;
        }

        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem 2rem;
        }

        .brand-mark {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-logo {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            display: grid;
            place-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #020617;
            box-shadow: 0 20px 30px rgba(34, 211, 238, 0.25);
        }

        .brand-copy h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 0.03em;
        }

        .brand-copy span {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .nav-links button {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-mid);
            padding: 0.65rem 1.2rem;
            border-radius: 999px;
            font-weight: 500;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .nav-links button:hover,
        .nav-links button.active {
            border-color: var(--border-strong);
            color: var(--text-high);
            background: rgba(255, 255, 255, 0.04);
        }

        .status-pill {
            padding: 0.35rem 0.95rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            text-transform: uppercase;
        }

        .status-live {
            background: linear-gradient(120deg, #22c55e, #4ade80);
            color: #022c22;
        }

        .status-idle {
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-mid);
        }

        .hero-grid {
            display: grid;
            grid-template-columns: minmax(280px, 0.85fr) minmax(280px, 1.15fr);
            gap: 2.2rem;
            margin-bottom: 1.75rem;
            align-items: center;
        }

        .hero-copy h2 {
            font-size: 2.75rem;
            margin: 0 0 1rem;
            letter-spacing: -0.01em;
        }

        .hero-copy p {
            color: var(--text-mid);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
        }

        .metric-pill {
            padding: 1.1rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .metric-pill span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .metric-pill strong {
            font-size: 1.2rem;
        }

        .layout-grid {
            display: grid;
            grid-template-columns: minmax(320px, 0.9fr) minmax(380px, 1.1fr);
            gap: 1.75rem;
            align-items: start;
        }

        .control-card .field-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .input-field,
        .text-area {
            width: 100%;
            background: rgba(2, 6, 23, 0.75);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 18px;
            padding: 1rem 1.15rem;
            color: var(--text-high);
            font-size: 1rem;
            font-family: inherit;
            transition: border 0.2s ease, box-shadow 0.2s ease;
            resize: vertical;
        }

        .input-field:focus,
        .text-area:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.15);
        }

        .primary-btn,
        .secondary-btn,
        .ghost-btn {
            border-radius: 18px;
            padding: 0.95rem 1.4rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .primary-btn {
            background: linear-gradient(120deg, #2563eb, #3b82f6);
            color: white;
            box-shadow: 0 15px 35px rgba(37, 99, 235, 0.35);
        }

        .secondary-btn {
            background: linear-gradient(120deg, #a855f7, #ec4899);
            color: white;
            box-shadow: 0 15px 35px rgba(236, 72, 153, 0.35);
        }

        .ghost-btn {
            background: transparent;
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-mid);
        }

        .primary-btn:disabled,
        .secondary-btn:disabled,
        .ghost-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .primary-btn:not(:disabled):hover,
        .secondary-btn:not(:disabled):hover,
        .ghost-btn:not(:disabled):hover {
            transform: translateY(-2px);
        }

        .switch {
            display: flex;
            align-items: center;
            gap: 0.85rem;
        }

        .switch input {
            display: none;
        }

        .switch-track {
            width: 48px;
            height: 26px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.25);
            position: relative;
            transition: background 0.2s ease;
        }

        .switch-track::after {
            content: '';
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            position: absolute;
            top: 3px;
            left: 4px;
            transition: transform 0.2s ease;
        }

        .switch input:checked + .switch-track {
            background: linear-gradient(120deg, var(--accent-cyan), var(--accent-green));
        }

        .switch input:checked + .switch-track::after {
            transform: translateX(20px);
        }

        .switch-label strong {
            display: block;
            font-size: 0.9rem;
        }

        .switch-label small {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .chip {
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            font-size: 0.8rem;
            color: var(--text-mid);
        }

        .alert-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.9rem;
        }

        .alert-toggle {
            border: none;
            border-radius: 24px;
            padding: 1rem;
            color: white;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            min-height: 120px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .alert-toggle span {
            display: block;
            font-size: 0.8rem;
            opacity: 0.85;
        }

        .alert-toggle .icon {
            font-size: 1.4rem;
            margin-bottom: 0.4rem;
        }

        .alert-toggle.alert-fire { background: linear-gradient(135deg, #ef4444, #f97316); }
        .alert-toggle.alert-flood { background: linear-gradient(135deg, #0ea5e9, #2563eb); }
        .alert-toggle.alert-crime { background: linear-gradient(135deg, #facc15, #fb923c); }
        .alert-toggle.alert-quake { background: linear-gradient(135deg, #c084fc, #7c3aed); }

        .alert-active {
            box-shadow: 0 20px 35px rgba(0, 0, 0, 0.35);
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        .demo-card {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .analysis-chips {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 0.75rem;
            margin-top: 1.25rem;
        }

        .analysis-chip {
            border-radius: 18px;
            padding: 0.85rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .analysis-chip strong {
            display: block;
            color: var(--text-high);
            margin-top: 0.35rem;
        }

        .theme-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .theme-pill {
            flex: 0 0 auto;
            padding: 0.75rem 1.1rem;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 150px;
            background: rgba(15, 23, 42, 0.65);
            color: var(--text-mid);
            text-align: left;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .theme-pill.active {
            border-color: rgba(34, 211, 238, 0.7);
            background: rgba(34, 211, 238, 0.1);
            color: var(--accent-cyan);
        }

        .theme-pill strong {
            display: block;
            font-size: 1rem;
            color: var(--text-high);
        }

        .theme-pill small {
            color: var(--text-muted);
        }

        .tone-low { color: var(--accent-green); }
        .tone-medium { color: var(--accent-amber); }
        .tone-high { color: #fb923c; }
        .tone-critical { color: var(--accent-rose); }
        .tone-idle { color: var(--text-muted); }

        .risk-dial {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
        }

        .dial-ring {
            width: 170px;
            height: 170px;
            border-radius: 50%;
            padding: 3px;
            display: grid;
            place-items: center;
            background: conic-gradient(var(--accent-green), rgba(148, 163, 184, 0.2));
        }

        .dial-core {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(2, 6, 23, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: grid;
            place-items: center;
            text-align: center;
        }

        .dial-core strong {
            font-size: 2.5rem;
        }

        .insight-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 2rem;
            align-items: center;
        }

        .summary-card {
            margin-top: 1.5rem;
        }

        .summary-card .body {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            min-height: 160px;
            line-height: 1.7;
            color: var(--text-mid);
        }

        .ops-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
        }

        .timeline-list,
        .data-feed {
            border-radius: 20px;
            background: rgba(2, 6, 23, 0.55);
            border: 1px solid rgba(148, 163, 184, 0.2);
            padding: 1.25rem;
            min-height: 220px;
        }

        .timeline-item {
            display: flex;
            gap: 0.9rem;
            padding: 0.75rem 0;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.2);
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(120deg, var(--accent-cyan), var(--accent-purple));
            margin-top: 0.35rem;
        }

        .feed-item {
            margin-bottom: 1rem;
        }

        .feed-item span {
            font-size: 0.75rem;
            color: var(--accent-cyan);
            letter-spacing: 0.08em;
        }

        .feed-item p {
            margin: 0.35rem 0 0;
            color: var(--text-mid);
            line-height: 1.5;
        }

        .notification-panel {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 20;
            background: rgba(3, 7, 18, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 1rem 1.4rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 280px;
            box-shadow: 0 20px 40px rgba(2, 6, 23, 0.6);
            -webkit-backdrop-filter: blur(18px);
            backdrop-filter: blur(18px);
        }

        .notification-panel.success { border-color: rgba(52, 211, 153, 0.7); }
        .notification-panel.error { border-color: rgba(248, 113, 113, 0.7); }
        .notification-panel.info { border-color: rgba(96, 165, 250, 0.7); }

        @media (max-width: 1200px) {
            .layout-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .hero-grid {
                grid-template-columns: 1fr;
            }
            .nav-bar {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width: 640px) {
            .nav-bar {
                padding: 1.25rem 1.5rem;
            }
            .glass-panel {
                padding: 1.5rem;
            }
            .hero-copy h2 {
                font-size: 2.1rem;
            }
        }
    </style>
</head>
<body class="app-body">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const NAV_LINKS = ['Overview', 'Signals', 'Operations', 'Settings'];
        const NAV_TARGETS = {
            Overview: 'overview-section',
            Signals: 'signals-section',
            Operations: 'operations-section',
            Settings: 'settings-section'
        };

        function App() {
            const [address, setAddress] = useState('25 Columbus Dr, Jersey City, NJ');
            const [query, setQuery] = useState('What are the current risks at this address?');
            const [assessment, setAssessment] = useState(null);
            const [loading, setLoading] = useState(false);
            const [loadingAnalysis, setLoadingAnalysis] = useState(false);
            const [autoRefresh, setAutoRefresh] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(null);
            const [systemStats, setSystemStats] = useState(null);
            const [isLive, setIsLive] = useState(false);
            const [alertAnimating, setAlertAnimating] = useState(false);
            const [notification, setNotification] = useState(null);
            const [activeAlerts, setActiveAlerts] = useState([]);
            const [alertHistory, setAlertHistory] = useState([]);
            const [activeSection, setActiveSection] = useState('Overview');
            const [preferredTheme, setPreferredTheme] = useState('midnight');
            const alertOptions = [
                { type: 'fire', label: 'Fire', icon: 'fas fa-fire', detail: 'Structural ignition', theme: 'alert-fire' },
                { type: 'flood', label: 'Flood', icon: 'fas fa-water', detail: 'Hydrologic surge', theme: 'alert-flood' },
                { type: 'crime', label: 'Crime', icon: 'fas fa-shield-alt', detail: 'Security watch', theme: 'alert-crime' },
                { type: 'earthquake', label: 'Quake', icon: 'fas fa-wave-square', detail: 'Seismic motion', theme: 'alert-quake' }
            ];

            const getRiskLabel = (score) => {
                if (score <= 2) return 'Low risk';
                if (score <= 4) return 'Elevated';
                if (score <= 7) return 'High attention';
                return 'Critical';
            };

            const getRiskTone = (score) => {
                if (score <= 2) return 'tone-low';
                if (score <= 4) return 'tone-medium';
                if (score <= 7) return 'tone-high';
                return 'tone-critical';
            };

            const registerAlertEvent = (type, status) => {
                setAlertHistory((prev) => {
                    const next = [...prev, { id: `${type}-${Date.now()}`, type, status, time: new Date().toLocaleTimeString() }];
                    return next.slice(-6);
                });
            };

            const handleNavClick = (link) => {
                setActiveSection(link);
                const targetId = NAV_TARGETS[link];
                if (!targetId) return;
                const element = document.getElementById(targetId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            const fetchSystemStats = async () => {
                try {
                    const response = await fetch('/stats');
                    if (response.ok) {
                        const data = await response.json();
                        setSystemStats(data);
                    }
                } catch (error) {
                    console.error('Error fetching system stats:', error);
                }
            };

            const fetchAssessment = async () => {
                if (!address.trim()) return;
                setLoading(true);
                setLoadingAnalysis(true);
                setIsLive(true);
                try {
                    const response = await fetch('/get_assessment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, query }),
                    });
                    if (response.ok) {
                        const result = await response.json();
                        setAssessment(result.data);
                        setLastUpdate(new Date().toLocaleTimeString());
                        fetchSystemStats();
                    }
                } catch (error) {
                    console.error('Error fetching assessment:', error);
                    setNotification({ type: 'error', message: 'Assessment failed. Please try again.' });
                    setTimeout(() => setNotification(null), 3200);
                } finally {
                    setLoading(false);
                    setTimeout(() => {
                        setLoadingAnalysis(false);
                        setIsLive(false);
                    }, 900);
                }
            };

            const injectTestAlert = async (alertType) => {
                if (!address.trim()) {
                    alert('Please enter an address first');
                    return;
                }
                const newActiveAlerts = activeAlerts.includes(alertType)
                    ? activeAlerts.filter((a) => a !== alertType)
                    : [...activeAlerts, alertType];
                setActiveAlerts(newActiveAlerts);

                if (newActiveAlerts.length === 0) {
                    setAlertAnimating(false);
                    setLoadingAnalysis(false);
                    fetchAssessment();
                    registerAlertEvent(alertType, 'Cleared');
                    return;
                }

                setAlertAnimating(true);
                setLoadingAnalysis(true);
                setNotification({ type: 'info', message: `${alertType.toUpperCase()} alert in play – refreshing signals...` });
                try {
                    const response = await fetch('/inject_test_alert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, alert_type: alertType, active_alerts: newActiveAlerts }),
                    });
                    if (response.ok) {
                        registerAlertEvent(alertType, newActiveAlerts.includes(alertType) ? 'Activated' : 'Cleared');
                        setNotification({ type: 'success', message: 'Scenario processed. Updating assessment...' });
                        setTimeout(() => {
                            fetchAssessment();
                            setAlertAnimating(false);
                            setNotification(null);
                        }, 2600);
                    }
                } catch (error) {
                    console.error('Error injecting alert:', error);
                    setNotification({ type: 'error', message: 'Alert simulation failed.' });
                    setAlertAnimating(false);
                    setLoadingAnalysis(false);
                    setTimeout(() => setNotification(null), 3200);
                }
            };

            const activateDemoMode = async (includeNews) => {
                if (!address.trim()) {
                    alert('Please enter an address first');
                    return;
                }
                setAlertAnimating(true);
                setLoadingAnalysis(true);
                try {
                    const response = await fetch('/activate_demo_mode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, include_news: includeNews }),
                    });
                    if (response.ok) {
                        const result = await response.json();
                        registerAlertEvent(result.alert_type, 'Demo Triggered');
                        setNotification({ type: 'success', message: result.message });
                        setTimeout(() => {
                            fetchAssessment();
                            setAlertAnimating(false);
                            setNotification(null);
                        }, 2600);
                    }
                } catch (error) {
                    console.error('Error activating demo mode:', error);
                    setNotification({ type: 'error', message: 'Demo activation failed.' });
                    setAlertAnimating(false);
                    setLoadingAnalysis(false);
                    setTimeout(() => setNotification(null), 3200);
                }
            };

            useEffect(() => {
                let interval;
                if (autoRefresh && address.trim()) {
                    interval = setInterval(() => {
                        fetchAssessment();
                    }, 30000);
                }
                return () => interval && clearInterval(interval);
            }, [autoRefresh, address]);

            useEffect(() => {
                if (address.trim()) {
                    setAssessment(null);
                    setActiveAlerts([]);
                    setLoadingAnalysis(true);
                    const timeout = setTimeout(() => setLoadingAnalysis(false), 4000);
                    return () => clearTimeout(timeout);
                }
            }, [address]);

            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            const matched = Object.entries(NAV_TARGETS).find(([, id]) => id === entry.target.id);
                            if (matched) {
                                setActiveSection(matched[0]);
                            }
                        }
                    });
                }, { threshold: 0.25, rootMargin: '-20% 0px -60% 0px' });

                const targetIds = Object.values(NAV_TARGETS);
                targetIds.forEach((id) => {
                    const element = document.getElementById(id);
                    if (element) {
                        observer.observe(element);
                    }
                });

                return () => observer.disconnect();
            }, []);

            useEffect(() => {
                fetchSystemStats();
            }, []);

            useEffect(() => {
                const body = document.querySelector('.app-body');
                if (!body) return;
                if (preferredTheme === 'luminous') {
                    body.classList.add('theme-light');
                } else {
                    body.classList.remove('theme-light');
                }
            }, [preferredTheme]);

            const documentsIndexed = systemStats?.documents_indexed ?? '—';
            const vectorSize = systemStats?.vector_store_size ?? '—';
            const activeFiles = systemStats?.data_management?.active_files ?? '—';
            const managementActive = systemStats?.data_management?.management_active ? 'Active' : 'Paused';
            const quoteValue = assessment?.insurance_quote ?? 0;
            const quoteDelta = quoteValue ? Math.round(quoteValue - 500) : 0;
            const riskTone = assessment ? getRiskTone(assessment.risk_score) : 'tone-idle';
            const gaugePercent = assessment ? Math.min(100, Math.max(0, (assessment.risk_score / 10) * 100)) : 0;
            const gaugeColorMap = preferredTheme === 'luminous'
                ? {
                    'tone-low': '#0f766e',
                    'tone-medium': '#b45309',
                    'tone-high': '#be123c',
                    'tone-critical': '#991b1b',
                    'tone-idle': '#94a3b8'
                }
                : {
                    'tone-low': '#34d399',
                    'tone-medium': '#fbbf24',
                    'tone-high': '#fb923c',
                    'tone-critical': '#f87171',
                    'tone-idle': '#475569'
                };
            const gaugeStyle = {
                background: `conic-gradient(${gaugeColorMap[riskTone]} ${gaugePercent}%, rgba(30, 41, 59, 0.9) ${gaugePercent}%)`
            };

            const heroTiles = [
                { label: 'Documents', value: documentsIndexed, icon: 'fas fa-layer-group' },
                { label: 'Vector Size', value: vectorSize, icon: 'fas fa-cubes' },
                { label: 'Active Files', value: activeFiles, icon: 'fas fa-database' },
                { label: 'Data Ops', value: managementActive, icon: 'fas fa-wave-square' }
            ];

            const analysisChips = assessment ? [
                { label: 'Documents referenced', value: assessment.relevant_documents },
                { label: 'Generated', value: new Date(assessment.timestamp).toLocaleString() },
                { label: 'Quote delta', value: `${quoteDelta >= 0 ? '+' : ''}$${quoteDelta}` }
            ] : [
                { label: 'Status', value: 'Awaiting analysis' },
                { label: 'Coverage', value: 'Select property' },
                { label: 'Refresh cadence', value: autoRefresh ? '30s auto' : 'Manual' }
            ];

            const defaultTimeline = [
                { id: 'boot', type: 'System', status: 'Standing by for alerts', time: new Date().toLocaleTimeString() }
            ];
            const timelineItems = alertHistory.length ? alertHistory : defaultTimeline;

            const defaultFeed = [
                { id: 'feed-1', title: 'Ready state', detail: 'Run an assessment to populate live intelligence.' },
                { id: 'feed-2', title: 'Streaming paused', detail: 'Activate demo mode to inject simulated events.' }
            ];
            const feedItems = assessment?.risk_summary
                ? assessment.risk_summary.split('\n').filter(Boolean).slice(0, 3).map((line, idx) => ({
                    id: `feed-${idx}`,
                    title: ['Primary insight', 'Secondary factor', 'Mitigation vector'][idx] || `Insight ${idx + 1}`,
                    detail: line.trim()
                }))
                : defaultFeed;

            return (
                <div className="app-shell">
                    {notification && (
                        <div className={`notification-panel ${notification.type}`}>
                            <i className="fas fa-bell text-lg"></i>
                            <span>{notification.message}</span>
                            <button onClick={() => setNotification(null)} className="text-sm text-gray-400">Dismiss</button>
                        </div>
                    )}
                    <div className="content-wrap space-y-6">
                        <div className="glass-panel nav-bar">
                            <div className="brand-mark">
                                <div className="brand-logo">S</div>
                                <div className="brand-copy">
                                    <h1>Sunny</h1>
                                    <span>Underwriting copilot</span>
                                </div>
                            </div>
                            <div className="nav-links">
                                {NAV_LINKS.map((link) => (
                                    <button
                                        key={link}
                                        className={link === activeSection ? 'active' : ''}
                                        onClick={() => handleNavClick(link)}
                                    >
                                        {link}
                                    </button>
                                ))}
                            </div>
                            <div className="flex items-center gap-3">
                                <span className={`status-pill ${isLive ? 'status-live' : 'status-idle'}`}>
                                    <i className="fas fa-circle"></i>{isLive ? 'Live' : 'Idle'}
                                </span>
                                <button className="ghost-btn" onClick={fetchAssessment} disabled={loading || !address.trim()}>
                                    <i className="fas fa-rotate-right mr-2"></i>Refresh
                                </button>
                            </div>
                        </div>

                        <div className="glass-panel hero-grid" id="overview-section">
                            <div className="hero-copy">
                                <p className="status-pill status-live" style={{ display: 'inline-flex' }}>Live scenario cockpit</p>
                                <h2>Instrumented insurance decisioning</h2>
                                <p>Monitor evolving exposures, inject live scenarios, and brief clients with cinematic clarity. Sunny orchestrates RAG intelligence, geospatial data, and premium modeling inside a single shared canvas.</p>
                                <div className="flex flex-wrap gap-3">
                                    <button className="primary-btn" onClick={fetchAssessment} disabled={loading || !address.trim()}>
                                        {loading ? 'Analyzing…' : 'Run assessment'}
                                    </button>
                                    <button className="ghost-btn" onClick={() => setAutoRefresh((prev) => !prev)}>
                                        {autoRefresh ? 'Disable auto' : 'Enable auto'} refresh
                                    </button>
                                </div>
                            </div>
                            <div className="metric-grid">
                                {heroTiles.map((tile) => (
                                    <div key={tile.label} className="metric-pill">
                                        <span><i className={`${tile.icon} mr-2`}></i>{tile.label}</span>
                                        <strong>{tile.value}</strong>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="layout-grid" id="signals-section">
                            <div className="space-y-6">
                                <div className="glass-panel control-card">
                                    <div className="flex items-center justify-between mb-4">
                                        <div>
                                            <p className="text-sm text-gray-400 uppercase tracking-[0.4em]">Control tower</p>
                                            <h3 className="text-2xl mt-1">Assess a property</h3>
                                        </div>
                                        <span className={`status-pill ${isLive ? 'status-live' : 'status-idle'}`}>{isLive ? 'Streaming' : 'Standby'}</span>
                                    </div>
                                    <div className="mb-4">
                                        <div className="field-label">Property address</div>
                                        <input className="input-field" type="text" value={address} onChange={(e) => setAddress(e.target.value)} placeholder="Enter full property address" />
                                    </div>
                                    <div className="mb-4">
                                        <div className="field-label">Assessment query</div>
                                        <textarea className="text-area" rows="4" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Describe risk factors or underwriting intent" />
                                    </div>
                                    <div className="flex items-center justify-between mb-4">
                                        <div className="switch">
                                            <label className="switch">
                                                <input type="checkbox" checked={autoRefresh} onChange={(e) => setAutoRefresh(e.target.checked)} />
                                                <span className="switch-track"></span>
                                            </label>
                                            <div className="switch-label">
                                                <strong>Auto refresh</strong>
                                                <small>30 second cadence</small>
                                            </div>
                                        </div>
                                        <div className="text-right text-sm text-gray-400">
                                            <div>Last update</div>
                                            <strong>{lastUpdate || '—'}</strong>
                                        </div>
                                    </div>
                                    <button className="primary-btn w-full" onClick={fetchAssessment} disabled={loading || !address.trim()}>
                                        {loading ? 'Analyzing with Sunny…' : 'Generate risk narrative'}
                                    </button>
                                    <div className="chip-row">
                                        <span className="chip"><i className="fas fa-database mr-2"></i>Active files · {activeFiles}</span>
                                        <span className="chip"><i className="fas fa-clock mr-2"></i>{autoRefresh ? 'Auto sync on' : 'Manual control'}</span>
                                    </div>
                                </div>

                                <div className="glass-panel" id="operations-section">
                                    <div className="flex items-center justify-between mb-4">
                                        <div>
                                            <p className="text-sm text-gray-400 uppercase tracking-[0.4em]">Alert lab</p>
                                            <h3 className="text-2xl mt-1">Inject scenarios</h3>
                                        </div>
                                        {alertAnimating && <span className="status-pill status-live">Processing</span>}
                                    </div>
                                    <div className="alert-grid mb-3">
                                        {alertOptions.map((option) => {
                                            const isActive = activeAlerts.includes(option.type);
                                            const disabled = alertAnimating && !isActive;
                                            return (
                                                <button key={option.type} className={`alert-toggle ${option.theme} ${isActive ? 'alert-active' : ''}`} disabled={disabled} onClick={() => injectTestAlert(option.type)}>
                                                    <div className="icon"><i className={option.icon}></i></div>
                                                    {isActive ? `${option.label} active` : option.label}
                                                    <span>{option.detail}</span>
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <div className="chip-row">
                                        {activeAlerts.length ? activeAlerts.map((alert) => (
                                            <span key={alert} className="chip">{alert.toUpperCase()} MODE</span>
                                        )) : <span className="chip">No active alerts</span>}
                                    </div>
                                </div>

                                <div className="glass-panel demo-card">
                                    <div>
                                        <p className="text-sm text-gray-400 uppercase tracking-[0.4em]">Demo studio</p>
                                        <h3 className="text-2xl mt-1">Orchestrate full narrative</h3>
                                        <p className="text-sm text-gray-400">Trigger synthetic news + alerts to showcase end-to-end situational awareness.</p>
                                    </div>
                                    <div className="flex flex-wrap gap-3">
                                        <button className="secondary-btn" onClick={() => activateDemoMode(true)} disabled={alertAnimating}>
                                            Full demo (news + alerts)
                                        </button>
                                        <button className="ghost-btn" onClick={() => activateDemoMode(false)} disabled={alertAnimating}>
                                            Rapid alert-only demo
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-6">
                                <div className="glass-panel insight-card">
                                    <div className="risk-dial">
                                        <div className="dial-ring" style={gaugeStyle}>
                                            <div className="dial-core">
                                                <div>
                                                    <strong>{assessment ? assessment.risk_score : '--'}</strong>
                                                    <div className="text-sm text-gray-400">/ 10</div>
                                                </div>
                                            </div>
                                        </div>
                                        <span className={riskTone}>{assessment ? getRiskLabel(assessment.risk_score) : 'Awaiting data'}</span>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-400 uppercase tracking-[0.4em]">Premium projection</p>
                                        <h3 className="text-4xl font-semibold mt-2">${quoteValue || 0}</h3>
                                        <p className="text-sm text-gray-400">For $1M coverage · {quoteDelta >= 0 ? '+' : ''}{quoteDelta}</p>
                                        <div className="analysis-chips">
                                            {analysisChips.map((chip) => (
                                                <div key={chip.label} className="analysis-chip">
                                                    {chip.label}
                                                    <strong>{chip.value}</strong>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="glass-panel summary-card">
                                    <div className="flex items-center justify-between mb-4">
                                        <div>
                                            <p className="text-sm text-gray-400 uppercase tracking-[0.4em]">Risk analysis</p>
                                            <h3 className="text-2xl mt-1">Narrative summary</h3>
                                        </div>
                                        {lastUpdate && !loadingAnalysis && (
                                            <span className="chip">Updated · {lastUpdate}</span>
                                        )}
                                    </div>
                                    <div className="body">
                                        {loadingAnalysis ? (
                                            <div className="animate-pulse text-gray-500">Sunny is synthesizing fresh intelligence…</div>
                                        ) : assessment ? (
                                            <div style={{ whiteSpace: 'pre-wrap' }}>{assessment.risk_summary}</div>
                                        ) : (
                                            <div className="text-gray-500">Run an assessment to unlock AI-authored context, mitigation cues, and premium logic.</div>
                                        )}
                                    </div>
                                </div>

                                <div className="glass-panel">
                                    <div className="flex items-center justify-between mb-4">
                                        <p className="text-sm text-gray-400 uppercase tracking-[0.4em]">Operations</p>
                                        <span className="chip">Live feed</span>
                                    </div>
                                    <div className="ops-grid">
                                        <div className="timeline-list">
                                            {timelineItems.map((item) => (
                                                <div key={item.id} className="timeline-item">
                                                    <div className="timeline-marker"></div>
                                                    <div>
                                                        <strong>{item.type}</strong>
                                                        <p className="text-gray-400 text-sm">{item.status}</p>
                                                        <small className="text-gray-500">{item.time}</small>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="data-feed">
                                            {feedItems.map((feed) => (
                                                <div key={feed.id} className="feed-item">
                                                    <span>{feed.title}</span>
                                                    <p>{feed.detail}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="glass-panel" id="settings-section">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <p className="text-sm text-gray-400 uppercase tracking-[0.4em]">Interface direction</p>
                                    <h3 className="text-2xl mt-1">Appearance preferences</h3>
                                </div>
                                <span className="chip">{preferredTheme === 'midnight' ? 'Midnight glass' : 'Luminous daylight'}</span>
                            </div>
                            <p className="text-gray-400 mb-4">Choose the tone you want to lead presentations with. We default to a cinematic dark shell for legibility across telemetry, but a lighter finance-forward palette is ready when you need a softer boardroom feel.</p>
                            <div className="theme-options mb-4">
                                <button type="button" className={`theme-pill ${preferredTheme === 'midnight' ? 'active' : ''}`} onClick={() => setPreferredTheme('midnight')}>
                                    <strong>Midnight glass</strong>
                                    <small>Best for control rooms + extended analysis</small>
                                </button>
                                <button type="button" className={`theme-pill ${preferredTheme === 'luminous' ? 'active' : ''}`} onClick={() => setPreferredTheme('luminous')}>
                                    <strong>Luminous daylight</strong>
                                    <small>Presentation-ready, high-trust finance vibe</small>
                                </button>
                            </div>
                            <p className="text-sm text-gray-500">Recommendation: stay in Midnight for day-to-day underwriting, then switch to Luminous when sharing trend decks or exec briefs where a light mode feels more traditional.</p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
